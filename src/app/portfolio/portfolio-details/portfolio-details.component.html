@if (errorMessage) {
  <div class="alert alert-danger mt-3">
    {{ errorMessage }}
  </div>
}

<div class="row">
  <!-- Left Column: Shares Details -->
  <div class="col-md-6">
    <div class="d-flex">
      <h4>Shares</h4>
      <span class="ms-2">{{ portfolio?.totalShareValue | number: '1.2-2' }}</span>
    </div>

    <ul class="list-group">
      @for (share of shares; track share.id) {
        <li class="list-group-item" (click)="openShareModal(share, sellModifyModal)">
          <div class="d-flex justify-content-between">
            <div>
              <strong>{{ share.displayName }}</strong>
              <p>Shares: {{ share.qty }}</p>
            </div>
            <div>
              <strong>{{share.currentPrice}}</strong>
              <span [ngClass]="{
                  'text-success': share.percentageChange >= 0,
                  'text-danger': share.percentageChange < 0
                }">
                ({{ share.percentageChange | number: '1.2-2' }}%)
              </span>
              <p>{{share.buyingPrice}}</p>
            </div>
          </div>
        </li>
      }
    </ul>
    <div class="mt-3">
      <ng-select
        [items]="stockResults"
        bindLabel="commonName"
        [minTermLength]="3"
        placeholder="Search for stock"
        [searchable]="true"
        [typeahead]="user$"
        [loading]="loading"
        [(ngModel)]="selectedStock">
        <ng-template ng-option-tmp let-item="item">
          <div>
            <strong>{{ item.commonName }}</strong> ({{ item.exchangeCodeBse }})
          </div>
        </ng-template>
      </ng-select>
      <input [(ngModel)]="shareAmount" type="number" class="form-control mt-2" placeholder="Amount" />
      <input [(ngModel)]="quantity" type="number" class="form-control mt-2" placeholder="Qty" />
      <button class="btn btn-primary mt-2" (click)="buyShares()">Buy Shares</button>
    </div>
  </div>

  <!-- Right Column: User Contributions -->
  <div class="col-md-6">
    <h4>User Contributions</h4>
    @for (userPortfolio of userPortfolios; track userPortfolio.username) {
      <div class="mt-4">
        <label>{{ userPortfolio.username }} ({{userPortfolio.currentValue | number:'1.2-2'}})</label>
        <div class="progress mb-2">
          <div
            class="progress-bar"
            role="progressbar"
            [style.width]="userPortfolio.contributionPercentage + '%'"
            attr.aria-valuenow="{{ userPortfolio.contributionPercentage }}"
            aria-valuemin="0"
            aria-valuemax="100">
            {{ userPortfolio.contributionPercentage | number: '1.2-2' }}%
          </div>
        </div>
        <button class="btn btn-danger" (click)="confirmDelete(userPortfolio.id)">Remove</button>
      </div>
    }
    <div class="mt-3">
      <ng-select
        [items]="users"
        bindLabel="displayName"
        bindValue="id"
        [(ngModel)]="selectedUser"
        [placeholder]="'Select a user'">
      </ng-select>

      <input [(ngModel)]="contributionAmount" type="number" class="form-control mt-2" placeholder="Contribution Amount" />
      <button class="btn btn-primary mt-2" (click)="addUserToPortfolio()">Add User</button>
    </div>
  </div>
</div>

<ng-template #sellModifyModal>
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="shareModalLabel">Update Share Price & Sell</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <div>
        <div class="mb-3">
          <div class="input-group mb-3">
            <input type="text" [(ngModel)]="selectedShare.currentPrice" class="form-control" aria-label="Text input with segmented dropdown button">
            <button type="button" class="btn btn-outline-secondary">Update Price</button>
          </div>
        </div>
        <div class="mb-3">
          <label for="sellQuantity" class="form-label">Sell Quantity</label>
          <input
            type="number"
            class="form-control"
            id="sellQuantity"
            [max]="selectedShare.qty"
            [min]="1"
            [(ngModel)]="sellQuantity"
            name="sellQuantity"
            placeholder="Quantity to Sell"
          />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      <button type="button" class="btn btn-primary" (click)="sellShares()">Sell</button>
    </div>
  </div>
</ng-template>
